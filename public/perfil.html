<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Meu Perfil - FitPlan PRO</title>
    <link rel="stylesheet" href="css/perfil.css">
</head>
<body>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2>üèãÔ∏è FitPlan PRO</h2>
            <nav id="navMenu">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="planos.html" class="nav-link">Planos</a>
                <a href="historico.html" class="nav-link">Hist√≥rico</a>
                <a href="exercicios.html" class="nav-link">Exerc√≠cios</a>
            </nav>
            
            <div class="logout-section">
                <a href="perfil.html" class="nav-link active" style="margin-bottom: 10px;">Perfil</a>
                <button class="btn-logout" id="logoutButton">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="welcome-header">
                <h1>O Teu Perfil</h1>
                <p>Gere os teus dados pessoais e acompanha as tuas medidas.</p>
            </header>

            <div class="grid-2">
                <form id="formPerfil" class="form-box">
                    <h2 style="color: #f9fafb; margin-bottom: 1.5rem;">Dados Pessoais</h2>
                    
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="nomeUser" disabled>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="emailUser" disabled>
                    </div>

                    <div class="grid-2" style="margin-top: 1rem;">
                        <div class="form-group">
                            <label for="nascimento">Data de Nascimento</label>
                            <input type="date" id="nascimento">
                        </div>
                        <div class="form-group">
                            <label for="genero">G√©nero</label>
                            <select id="genero">
                                <option value="">Seleciona...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="altura">Altura (cm)</label>
                            <input type="number" id="altura" placeholder="Ex: 175">
                        </div>
                        <div class="form-group">
                            <label for="peso">Peso Atual (kg)</label>
                            <input type="number" id="peso" step="0.1" placeholder="Ex: 70.5">
                        </div>
                    </div>

                    <div class="item-actions" style="margin-top: 2rem;">
                        <button type="submit" class="primary-button">Guardar Altera√ß√µes</button>
                    </div>
                    <p id="mensagem" class="mensagem"></p>
                </form>

                <div>
                    <div class="imc-card">
                        <span class="imc-label">O teu IMC Atual</span>
                        <div id="imcValor" class="imc-valor">--</div>
                        <div id="imcStatus" class="imc-status">Preenche peso e altura</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 1. Verifica√ß√£o de Autentica√ß√£o
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) window.location.href = "/login.html";

        // ==================================================
        // INJE√á√ÉO DA SIDEBAR DE ADMIN
        // ==================================================
        if (user.role === 'admin') {
            const navMenu = document.getElementById("navMenu");
            const adminLinks = `
                <div class="admin-menu">
                    <p>Administra√ß√£o</p>
                    <a href="grupos.html" class="nav-link">Gerir Grupos</a>
                    <a href="adicionarExercicios.html" class="nav-link">Gerir Exerc√≠cios</a>
                </div>
            `;
            navMenu.insertAdjacentHTML('beforeend', adminLinks);
        }
        // ==================================================

        // 2. Elementos do DOM
        const formPerfil = document.getElementById("formPerfil");
        const mensagemEl = document.getElementById("mensagem");

        const elNome = document.getElementById("nomeUser");
        const elEmail = document.getElementById("emailUser");
        const elNascimento = document.getElementById("nascimento");
        const elGenero = document.getElementById("genero");
        const elAltura = document.getElementById("altura");
        const elPeso = document.getElementById("peso");
        
        const elImcValor = document.getElementById("imcValor");
        const elImcStatus = document.getElementById("imcStatus");

        // 3. Fun√ß√£o Auxiliar para Mensagens
        function setMensagem(texto, tipo) {
            mensagemEl.textContent = texto;
            mensagemEl.className = tipo === "erro" ? "mensagem mensagem-erro" : "mensagem mensagem-sucesso";
        }

        // 4. Calcular IMC em Tempo Real
        function calcularIMC() {
            const altura = parseFloat(elAltura.value) / 100; // Converter cm para metros
            const peso = parseFloat(elPeso.value);

            if (altura > 0 && peso > 0) {
                const imc = (peso / (altura * altura)).toFixed(1);
                elImcValor.textContent = imc;
                
                let status = "";
                let cor = "";

                if (imc < 18.5) { status = "Abaixo do peso"; cor = "#38bdf8"; }
                else if (imc < 24.9) { status = "Peso Normal"; cor = "#4ade80"; }
                else if (imc < 29.9) { status = "Sobrepeso"; cor = "#fbbf24"; }
                else { status = "Obesidade"; cor = "#f87171"; }

                elImcStatus.textContent = status;
                elImcStatus.style.color = cor;
            } else {
                elImcValor.textContent = "--";
                elImcStatus.textContent = "Dados insuficientes";
                elImcStatus.style.color = "#9ca3af";
            }
        }

        // Listeners para recalcular ao digitar
        elAltura.addEventListener("input", calcularIMC);
        elPeso.addEventListener("input", calcularIMC);

        // 5. Carregar Dados do Perfil (GET)
        async function carregarPerfil() {
            try {
                elNome.value = user.nome;
                elEmail.value = user.email || "A carregar...";

                const resp = await fetch(`/api/perfil/${user.id}`);
                if (!resp.ok) throw new Error("Erro na API");
                const dados = await resp.json();

                elNome.value = dados.nome || user.nome;
                elEmail.value = dados.email || user.email || "Email n√£o dispon√≠vel"; 

                if (dados.data_nascimento) elNascimento.value = dados.data_nascimento.slice(0, 10);
                if (dados.genero) elGenero.value = dados.genero;
                if (dados.altura_cm) elAltura.value = dados.altura_cm;
                if (dados.peso_inicial_kg) elPeso.value = dados.peso_inicial_kg;

                calcularIMC(); 
            } catch (err) {
                console.log("Perfil ainda n√£o criado ou erro ao carregar.", err);
                if(!elEmail.value || elEmail.value === "A carregar...") {
                     elEmail.value = user.email || "Indispon√≠vel";
                }
            }
        }

        // 6. Guardar Altera√ß√µes (PUT)
        formPerfil.onsubmit = async (e) => {
            e.preventDefault();
            setMensagem("", "");

            const dados = {
                data_nascimento: elNascimento.value,
                genero: elGenero.value,
                altura_cm: elAltura.value,
                peso_inicial_kg: elPeso.value
            };

            try {
                const resp = await fetch(`/api/perfil/${user.id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dados)
                });

                if (resp.ok) {
                    setMensagem("Perfil atualizado com sucesso!", "sucesso");
                } else {
                    setMensagem("Erro ao atualizar dados.", "erro");
                }
            } catch (err) {
                setMensagem("Erro de comunica√ß√£o com o servidor.", "erro");
            }
        };

        // 7. Logout
        document.getElementById('logoutButton').onclick = () => {
            localStorage.removeItem("user");
            window.location.href = "/login.html";
        };

        // Inicializa√ß√£o
        carregarPerfil();
    </script>
</body>
</html>