<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Planos de Treino - FitPlan PRO</title>
    <link rel="stylesheet" href="css/planos.css">
</head>
<body>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2>üèãÔ∏è FitPlan PRO</h2>
            <nav>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="planos.html" class="nav-link active">Planos</a>
                <a href="historico.html" class="nav-link">Hist√≥rico</a>
                <a href="exercicios.html" class="nav-link">Exerc√≠cios</a>
            </nav>
            <div class="logout-section">
                <a href="perfil.html" class="nav-link" style="margin-bottom: 10px;">Perfil</a>
                <button class="btn-logout" id="logoutButton">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="welcome-header">
                <h1>Os Teus Planos</h1>
                <p id="infoUser" style="color: #9ca3af; font-size: 0.9rem; margin-top: 5px;"></p>
            </header>

            <form id="formPlano" class="form-box">
                <div class="form-group">
                    <label for="nomePlano">Nome do plano</label>
                    <input id="nomePlano" type="text" placeholder="Ex.: Hipertrofia ABC" required />
                </div>
                <div class="form-group">
                    <label for="objetivoPlano">Objetivo (opcional)</label>
                    <input id="objetivoPlano" type="text" placeholder="Ex.: Ganho de massa" />
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="dataInicio">Data in√≠cio</label>
                        <input id="dataInicio" type="date" />
                    </div>
                    <div class="form-group">
                        <label for="dataFim">Data fim</label>
                        <input id="dataFim" type="date" />
                    </div>
                </div>
                <button class="primary-button" type="submit">Criar Novo Plano</button>
                <p id="mensagem" class="mensagem"></p>
            </form>

            <div class="list-section">
                <h2>Planos Ativos</h2>
                <ul id="listaPlanos" class="list">
                    <li class="list-empty">A carregar...</li>
                </ul>
            </div>
        </main>
    </div>

    <div id="modalEditar" class="modal hidden">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Editar Plano</h2>
                <button id="btnFecharModal" class="modal-close">‚úï</button>
            </div>
            <form id="formEditarPlano">
                <input type="hidden" id="editPlanoId" />
                <div class="form-group">
                    <label for="editNome">Nome</label>
                    <input id="editNome" type="text" required />
                </div>
                <div class="form-group">
                    <label for="editObjetivo">Objetivo</label>
                    <input id="editObjetivo" type="text" />
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="editDataInicio">In√≠cio</label>
                        <input id="editDataInicio" type="date" />
                    </div>
                    <div class="form-group">
                        <label for="editDataFim">Fim</label>
                        <input id="editDataFim" type="date" />
                    </div>
                </div>
                <button type="submit" class="primary-button">Guardar Altera√ß√µes</button>
                <p id="mensagemEditar" class="mensagem"></p>
            </form>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) window.location.href = "/login.html";

        const roleTratado = user.role === "admin" ? "Admin" : "Atleta";
        document.getElementById("infoUser").textContent = `Autenticado como: ${user.nome} ‚Äî ${roleTratado}`;

        const formPlano = document.getElementById("formPlano");
        const mensagemEl = document.getElementById("mensagem");
        const listaPlanosEl = document.getElementById("listaPlanos");
        const modal = document.getElementById("modalEditar");
        const btnFecharModal = document.getElementById("btnFecharModal");
        const formEditar = document.getElementById("formEditarPlano");

        function setMensagem(texto, tipo) {
            mensagemEl.textContent = texto || "";
            mensagemEl.className = "mensagem";
            if (tipo === "erro") mensagemEl.classList.add("mensagem-erro");
            if (tipo === "sucesso") mensagemEl.classList.add("mensagem-sucesso");
        }

        formPlano.onsubmit = async (e) => {
            e.preventDefault();
            setMensagem("", "");

            const dados = {
                utilizador_id: user.id,
                nome: document.getElementById("nomePlano").value.trim(),
                objetivo: document.getElementById("objetivoPlano").value.trim(),
                data_inicio: document.getElementById("dataInicio").value,
                data_fim: document.getElementById("dataFim").value
            };

            try {
                const resp = await fetch("/api/planos", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dados)
                });

                const resData = await resp.json();

                if (resp.ok) {
                    setMensagem("Plano criado com sucesso!", "sucesso");
                    formPlano.reset();
                    carregarPlanos(); 
                } else {
                    setMensagem(resData.mensagem || "Erro ao criar plano.", "erro");
                }
            } catch (err) {
                setMensagem("Erro de liga√ß√£o ao servidor.", "erro");
            }
        };

        function abrirModalEditar(plano) {
            document.getElementById("editPlanoId").value = plano.id;
            document.getElementById("editNome").value = plano.nome || "";
            document.getElementById("editObjetivo").value = plano.objetivo || "";
            document.getElementById("editDataInicio").value = plano.data_inicio ? plano.data_inicio.slice(0, 10) : "";
            document.getElementById("editDataFim").value = plano.data_fim ? plano.data_fim.slice(0, 10) : "";
            modal.classList.remove("hidden");
        }

        btnFecharModal.onclick = () => modal.classList.add("hidden");
        window.onclick = (e) => { if (e.target === modal) modal.classList.add("hidden"); };

        async function carregarPlanos() {
            try {
                const resp = await fetch(`/api/planos/${user.id}`);
                const planos = await resp.json();
                listaPlanosEl.innerHTML = "";

                if (!Array.isArray(planos) || planos.length === 0) {
                    listaPlanosEl.innerHTML = `<li class="list-empty">Ainda n√£o tens planos criados.</li>`;
                    return;
                }

                planos.forEach(p => {
                    const li = document.createElement("li");
                    li.className = "list-item";
                    li.innerHTML = `
                        <div class="item-left">
                            <h3>${p.nome}</h3>
                            <p class="muted">${p.objetivo || "Sem objetivo definido"}</p>
                        </div>
                        <div class="item-actions">
                            <a href="/plano_detalhe.html?planoId=${p.id}" class="secondary-button">Abrir</a>
                            <button class="secondary-button btn-edit-trigger">Editar</button>
                            <button class="danger-button btn-del-trigger">Desativar</button>
                        </div>
                    `;
                    li.querySelector(".btn-edit-trigger").onclick = () => abrirModalEditar(p);
                    li.querySelector(".btn-del-trigger").onclick = async () => {
                        if (!confirm(`Desativar o plano "${p.nome}"?`)) return;
                        await fetch(`/api/planos/${p.id}/${user.id}`, { method: "DELETE" });
                        carregarPlanos();
                    };
                    listaPlanosEl.appendChild(li);
                });
            } catch (e) {
                listaPlanosEl.innerHTML = `<li class="list-empty">Erro ao carregar planos.</li>`;
            }
        }

        formEditar.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById("editPlanoId").value;
            const dados = {
                nome: document.getElementById("editNome").value.trim(),
                objetivo: document.getElementById("editObjetivo").value.trim(),
                data_inicio: document.getElementById("editDataInicio").value,
                data_fim: document.getElementById("editDataFim").value
            };
            const resp = await fetch(`/api/planos/${id}/${user.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dados)
            });
            if (resp.ok) {
                modal.classList.add("hidden");
                carregarPlanos();
            }
        };

        document.getElementById('logoutButton').onclick = () => {
            localStorage.removeItem("user");
            window.location.href = "/login.html";
        };

        carregarPlanos();
    </script>
</body>
</html>