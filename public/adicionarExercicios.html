<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Adicionar Exerc√≠cios - FitPlan PRO</title>
    <link rel="stylesheet" href="css/planos.css">
    
    <style>
        .video-preview {
            margin-top: 10px;
            display: none;
            width: 100%;
        }
        .video-preview video {
            width: 100%;
            max-height: 250px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: #020617;
        }
        input[type="file"] {
            padding: 10px;
            background: #020617;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #9ca3af;
            width: 100%;
            cursor: pointer;
        }
        input[type="file"]::file-selector-button {
            background: #1f2933;
            color: #38bdf8;
            border: 1px solid #38bdf8;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 15px;
            transition: 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background: #38bdf8;
            color: #020617;
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2>üèãÔ∏è FitPlan PRO</h2>
            <nav>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="planos.html" class="nav-link">Meus Planos</a>
                <a href="historico.html" class="nav-link">Hist√≥rico</a>
                <a href="exercicios.html" class="nav-link active">Exerc√≠cios</a>
            </nav>
            <div class="logout-section">
                <button class="btn-logout" id="logoutButton">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="welcome-header">
                <h1>Gest√£o de Exerc√≠cios</h1>
                <p>√Årea administrativa para criar e editar exerc√≠cios.</p>
                <div style="margin-top: 15px;">
                    <a href="exercicios.html" class="secondary-button" style="text-decoration: none;">&larr; Voltar √† Pesquisa</a>
                    <a href="grupos.html" class="secondary-button" style="text-decoration: none; margin-left: 10px;">Gerir Grupos Musculares</a>
                </div>
            </header>

            <form id="formExercicio" class="form-box">
                <h2 style="color: #f9fafb; margin-bottom: 1.5rem;">Adicionar Novo Exerc√≠cio</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="nomeExercicio">Nome do exerc√≠cio</label>
                        <input type="text" id="nomeExercicio" placeholder="Ex.: Supino Reto com Barra" required />
                    </div>

                    <div class="form-group">
                        <label for="grupoMuscular">Grupo Muscular</label>
                        <select id="grupoMuscular" required>
                            <option value="">A carregar grupos...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="descricaoExercicio">Descri√ß√£o (Opcional)</label>
                    <textarea id="descricaoExercicio" rows="3" placeholder="Dicas de execu√ß√£o..." 
                        style="width: 100%; padding: 1rem; border-radius: 12px; background: #020617; border: 1px solid #1f2933; color: white; resize: vertical;"></textarea>
                </div>

                <div class="form-group">
                    <label for="videoCaminho">V√≠deo de Execu√ß√£o (Opcional)</label>
                    <input type="file" id="videoCaminho" accept="video/*" />
                    <div id="videoPreview" class="video-preview">
                        <video id="previewPlayer" controls></video>
                    </div>
                </div>

                <div class="item-actions" style="margin-top: 2rem;">
                    <button type="reset" class="secondary-button">Limpar Campos</button>
                    <button type="submit" class="primary-button">Guardar Exerc√≠cio</button>
                </div>
                <p id="mensagem" class="mensagem"></p>
            </form>

            <div class="list-section">
                <h2>Exerc√≠cios Ativos</h2>
                <ul id="listaExercicios" class="list">
                    <li class="list-empty">A carregar biblioteca...</li>
                </ul>
            </div>
        </main>
    </div>

    <div id="modalEditar" class="modal hidden">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Editar Exerc√≠cio</h2>
                <button id="btnFecharModal" class="modal-close">‚úï</button>
            </div>
            
            <form id="formEditarExercicio">
                <input type="hidden" id="editId" />

                <div class="form-group">
                    <label for="editNome">Nome</label>
                    <input type="text" id="editNome" required />
                </div>

                <div class="form-group">
                    <label for="editGrupo">Grupo Muscular</label>
                    <select id="editGrupo" required></select>
                </div>

                <div class="form-group">
                    <label for="editDescricao">Descri√ß√£o</label>
                    <textarea id="editDescricao" rows="3" style="width: 100%; padding: 0.8rem; border-radius: 10px; background: #020617; border: 1px solid #334155; color: white;"></textarea>
                </div>

                <div class="form-group">
                    <label for="editVideo">Novo V√≠deo (Opcional)</label>
                    <input type="file" id="editVideo" accept="video/*" />
                    
                    <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="removerVideo" style="width: auto;" />
                        <label for="removerVideo" style="color: #f87171; margin: 0; cursor: pointer;">Remover v√≠deo atual?</label>
                    </div>
                </div>

                <div id="editVideoPreview" class="video-preview" style="display:none; margin-bottom: 1rem;">
                    <video id="editPreviewPlayer" controls></video>
                </div>

                <button type="submit" class="primary-button">Guardar Altera√ß√µes</button>
                <p id="msgEditar" class="mensagem"></p>
            </form>
        </div>
    </div>

    <script>
        // --- 1. VERIFICA√á√ÉO DE SEGURAN√áA (ADMIN) ---
        const user = JSON.parse(localStorage.getItem("user"));
        
        if (!user) {
            window.location.href = "/login.html";
        } else if (user.role !== "admin") {
            // Removido o alert, redireciona diretamente
            window.location.href = "/dashboard.html";
        }

        // --- 2. ELEMENTOS DOM ---
        const formExercicio = document.getElementById("formExercicio");
        const selectGrupo = document.getElementById("grupoMuscular");
        const inputVideo = document.getElementById("videoCaminho");
        const previewWrap = document.getElementById("videoPreview");
        const previewPlayer = document.getElementById("previewPlayer");
        const listaExerciciosEl = document.getElementById("listaExercicios");
        const mensagemEl = document.getElementById("mensagem");

        // Modal Elements
        const modal = document.getElementById("modalEditar");
        const btnFecharModal = document.getElementById("btnFecharModal");
        const formEditar = document.getElementById("formEditarExercicio");
        const msgEditarEl = document.getElementById("msgEditar");

        // --- 3. FUN√á√ïES AUXILIARES ---
        function setMensagem(texto, tipo) {
            mensagemEl.textContent = texto;
            mensagemEl.className = tipo === "erro" ? "mensagem mensagem-erro" : "mensagem mensagem-sucesso";
        }

        function setMsgEditar(texto, tipo) {
            msgEditarEl.textContent = texto;
            msgEditarEl.className = tipo === "erro" ? "mensagem mensagem-erro" : "mensagem mensagem-sucesso";
        }

        // --- 4. CARREGAMENTO DE DADOS ---
        async function carregarGrupos() {
            try {
                const resp = await fetch("/api/grupos-musculares");
                const grupos = await resp.json();
                
                let options = `<option value="">Seleciona...</option>`;
                grupos.forEach(g => {
                    options += `<option value="${g.id}">${g.nome}</option>`;
                });

                selectGrupo.innerHTML = options;
                document.getElementById("editGrupo").innerHTML = options; 
            } catch (err) {
                console.error("Erro grupos", err);
            }
        }

        function renderListaAdmin(exercicios) {
            listaExerciciosEl.innerHTML = "";

            if (!Array.isArray(exercicios) || exercicios.length === 0) {
                listaExerciciosEl.innerHTML = '<li class="list-empty">Ainda n√£o existem exerc√≠cios criados.</li>';
                return;
            }

            exercicios.forEach((e) => {
                const li = document.createElement("li");
                li.className = "list-item"; 

                // Conte√∫do do Card
                const leftDiv = document.createElement("div");
                leftDiv.className = "item-left";
                
                leftDiv.innerHTML = `
                    <h3>${e.nome}</h3>
                    <p class="muted" style="margin-bottom: 0.5rem;">${e.grupo_nome}</p>
                    ${e.descricao ? `<p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.5rem;">${e.descricao}</p>` : ''}
                    ${e.video_caminho ? `
                        <div style="margin-top: 10px;">
                            <video src="${e.video_caminho}" controls style="height: 120px; border-radius: 8px; border: 1px solid #334155;"></video>
                        </div>
                    ` : ''}
                `;

                // A√ß√µes
                const actionsDiv = document.createElement("div");
                actionsDiv.className = "item-actions";
                
                const btnEditar = document.createElement("button");
                btnEditar.className = "secondary-button";
                btnEditar.textContent = "Editar";
                btnEditar.onclick = () => abrirModalEditar(e);

                const btnDesativar = document.createElement("button");
                btnDesativar.className = "danger-button";
                btnDesativar.textContent = "Desativar";
                btnDesativar.onclick = () => desativarExercicio(e);

                actionsDiv.appendChild(btnEditar);
                actionsDiv.appendChild(btnDesativar);

                li.appendChild(leftDiv);
                li.appendChild(actionsDiv);
                listaExerciciosEl.appendChild(li);
            });
        }

        async function carregarExercicios() {
            try {
                const resp = await fetch("/api/exercicios");
                const exercicios = await resp.json();
                renderListaAdmin(exercicios);
            } catch (err) {
                listaExerciciosEl.innerHTML = '<li class="list-empty">Erro ao carregar lista.</li>';
            }
        }

        // --- 5. L√ìGICA DO FORMUL√ÅRIO (CRIAR) ---
        inputVideo.onchange = () => {
            const file = inputVideo.files[0];
            if (file) {
                previewPlayer.src = URL.createObjectURL(file);
                previewWrap.style.display = "block";
            } else {
                previewWrap.style.display = "none";
            }
        };

        formExercicio.onreset = () => {
            setMensagem("", "");
            previewWrap.style.display = "none";
            previewPlayer.src = "";
        };

        formExercicio.onsubmit = async (e) => {
            e.preventDefault();
            setMensagem("", "");

            const formData = new FormData();
            formData.append("nome", document.getElementById("nomeExercicio").value.trim());
            formData.append("grupo_muscular_id", selectGrupo.value);
            formData.append("descricao", document.getElementById("descricaoExercicio").value);
            
            if (inputVideo.files[0]) {
                formData.append("video", inputVideo.files[0]);
            }

            try {
                const resp = await fetch("/api/exercicios", { method: "POST", body: formData });
                const data = await resp.json();

                if (resp.ok) {
                    setMensagem("Exerc√≠cio criado com sucesso!", "sucesso");
                    formExercicio.reset();
                    carregarExercicios();
                } else {
                    setMensagem(data.mensagem || "Erro ao criar.", "erro");
                }
            } catch (err) {
                setMensagem("Erro de comunica√ß√£o.", "erro");
            }
        };

        // --- 6. A√á√ïES DE ITEM ---
        async function desativarExercicio(e) {
            if (!confirm(`Desativar o exerc√≠cio "${e.nome}"?`)) return;
            try {
                const resp = await fetch(`/api/exercicios/${e.id}`, { method: "DELETE" });
                if (resp.ok) {
                    carregarExercicios();
                } else {
                    alert("Erro ao desativar.");
                }
            } catch(err) { console.error(err); }
        }

        function abrirModalEditar(ex) {
            document.getElementById("editId").value = ex.id;
            document.getElementById("editNome").value = ex.nome;
            document.getElementById("editGrupo").value = ex.grupo_muscular_id;
            document.getElementById("editDescricao").value = ex.descricao || "";
            
            document.getElementById("removerVideo").checked = false;
            document.getElementById("editVideo").value = "";
            document.getElementById("editVideoPreview").style.display = "none";

            setMsgEditar("", "");
            modal.classList.remove("hidden");
        }

        document.getElementById("editVideo").onchange = function() {
            const file = this.files[0];
            if (file) {
                document.getElementById("editPreviewPlayer").src = URL.createObjectURL(file);
                document.getElementById("editVideoPreview").style.display = "block";
            }
        };

        formEditar.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById("editId").value;
            
            const formData = new FormData();
            formData.append("nome", document.getElementById("editNome").value);
            formData.append("grupo_muscular_id", document.getElementById("editGrupo").value);
            formData.append("descricao", document.getElementById("editDescricao").value);

            if (document.getElementById("removerVideo").checked) formData.append("remover_video", "1");
            if (document.getElementById("editVideo").files[0]) formData.append("video", document.getElementById("editVideo").files[0]);

            try {
                const resp = await fetch(`/api/exercicios/${id}`, { method: "PUT", body: formData });
                if (resp.ok) {
                    modal.classList.add("hidden");
                    carregarExercicios();
                } else {
                    setMsgEditar("Erro ao atualizar.", "erro");
                }
            } catch(err) {
                setMsgEditar("Erro de servidor.", "erro");
            }
        };

        btnFecharModal.onclick = () => modal.classList.add("hidden");
        window.onclick = (e) => { if (e.target === modal) modal.classList.add("hidden"); };

        document.getElementById('logoutButton').onclick = () => {
            localStorage.removeItem("user");
            window.location.href = "/login.html";
        };

        // --- INICIALIZA√á√ÉO ---
        carregarGrupos();
        carregarExercicios();
    </script>
</body>
</html>