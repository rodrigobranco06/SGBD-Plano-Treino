<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Detalhe do Plano - FitPlan PRO</title>
    <link rel="stylesheet" href="css/planos.css">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2>üèãÔ∏è FitPlan PRO</h2>
            <nav id="navMenu">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="planos.html" class="nav-link active">Meus Planos</a>
                <a href="historico.html" class="nav-link">Hist√≥rico</a>
                <a href="exercicios.html" class="nav-link">Exerc√≠cios</a>
            </nav>
            <div class="logout-section">
                <a href="perfil.html" class="nav-link" style="margin-bottom: 10px;">Perfil</a>
                <button class="btn-logout" id="logoutButton">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="welcome-header">
                <h1 id="tituloPlano">Plano</h1>
                <p id="subPlano" class="muted">Gest√£o de exerc√≠cios por dia da semana.</p>
                <p id="infoUser" style="color: #38bdf8; font-size: 0.85rem; margin-top: 10px;"></p>
            </header>

            <form id="formAdd" class="form-box">
                <h2 style="margin-bottom: 1.5rem; color: #f9fafb;">Adicionar Exerc√≠cio ao Plano</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="diaSemana">Dia da semana</label>
                        <select id="diaSemana" required>
                            <option value="">Seleciona...</option>
                            <option>Segunda</option>
                            <option>Ter√ßa</option>
                            <option>Quarta</option>
                            <option>Quinta</option>
                            <option>Sexta</option>
                            <option>S√°bado</option>
                            <option>Domingo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exercicio">Exerc√≠cio</label>
                        <select id="exercicio" required>
                            <option value="">A carregar...</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label for="ordem">Ordem de execu√ß√£o</label>
                        <input id="ordem" type="number" min="1" value="1" />
                    </div>
                    <div class="form-group">
                        <label for="descanso">Descanso (segundos)</label>
                        <input id="descanso" type="number" min="0" placeholder="Ex: 90"/>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label for="series">S√©ries</label>
                        <input id="series" type="number" min="1" placeholder="Ex: 3" required />
                    </div>
                    <div class="form-group">
                        <label for="reps">Repeti√ß√µes</label>
                        <input id="reps" type="number" min="1" placeholder="Ex: 12" required />
                    </div>
                </div>

                <div class="form-group">
                    <label for="carga">Carga sugerida (kg)</label>
                    <input id="carga" type="number" step="0.5" min="0" placeholder="Ex: 40 (Opcional)"/>
                </div>

                <button class="primary-button" type="submit">Adicionar ao Plano</button>
                <p id="mensagem" class="mensagem"></p>
            </form>

            <div class="list-section">
                <h2>Organiza√ß√£o Semanal</h2>
                <div id="conteudo" class="days-wrap">
                    <p class="muted">A carregar exerc√≠cios...</p>
                </div>
            </div>
        </main>
    </div>

<script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "/login.html";

    const roleTratado = user.role === "admin" ? "Admin" : "Atleta";
    document.getElementById("infoUser").textContent = `Autenticado como: ${user.nome} ‚Äî ${roleTratado}`;

    // ==================================================
    // INJE√á√ÉO DA SIDEBAR DE ADMIN
    // ==================================================
    if (user.role === 'admin') {
        const navMenu = document.getElementById("navMenu");
        const adminLinks = `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(148, 163, 184, 0.1);">
                <p style="padding-left: 1.2rem; margin-bottom: 8px; font-size: 0.75rem; color: #64748b; font-weight: bold; text-transform: uppercase;">
                    Administra√ß√£o
                </p>
                <a href="grupos.html" class="nav-link">Gerir Grupos</a>
                <a href="adicionarExercicios.html" class="nav-link">Gerir Exerc√≠cios</a>
            </div>
        `;
        navMenu.insertAdjacentHTML('beforeend', adminLinks);
    }
    // ==================================================

    const params = new URLSearchParams(window.location.search);
    const planoId = params.get("planoId");
    if (!planoId) window.location.href = "/planos.html";

    const tituloPlano = document.getElementById("tituloPlano");
    const subPlano = document.getElementById("subPlano");
    const selectEx = document.getElementById("exercicio");
    const conteudo = document.getElementById("conteudo");
    const mensagemEl = document.getElementById("mensagem");
    const formAdd = document.getElementById("formAdd");

    function setMensagem(texto, tipo) {
        mensagemEl.textContent = texto || "";
        mensagemEl.className = "mensagem";
        if (tipo === "erro") mensagemEl.classList.add("mensagem-erro");
        if (tipo === "sucesso") mensagemEl.classList.add("mensagem-sucesso");
    }

    async function carregarPlano() {
        const resp = await fetch(`/api/planos/${planoId}/detalhe/${user.id}`);
        const plano = await resp.json();
        if (!resp.ok) {
            alert(plano.mensagem || "Plano n√£o encontrado.");
            window.location.href = "/planos.html";
            return;
        }
        tituloPlano.textContent = plano.nome;
        subPlano.textContent = plano.objetivo ? `Objetivo: ${plano.objetivo}` : "Sem objetivo definido";
    }

    async function carregarExerciciosSelect() {
        const resp = await fetch("/api/exercicios");
        const exs = await resp.json();
        selectEx.innerHTML = "";

        if (!Array.isArray(exs) || exs.length === 0) {
            selectEx.innerHTML = `<option value="">Sem exerc√≠cios (cria em Exerc√≠cios)</option>`;
            selectEx.disabled = true;
            return;
        }

        selectEx.disabled = false;
        selectEx.innerHTML = `<option value="">Seleciona o exerc√≠cio...</option>`;
        exs.forEach(e => {
            const opt = document.createElement("option");
            opt.value = e.id;
            opt.textContent = `${e.grupo_nome} ‚Äî ${e.nome}`;
            selectEx.appendChild(opt);
        });
    }

    function agruparPorDia(itens) {
        const dias = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
        const map = {};
        dias.forEach(d => map[d] = []);
        (itens || []).forEach(i => {
            const d = i.dia_semana || "Segunda";
            if (!map[d]) map[d] = [];
            map[d].push(i);
        });
        return { dias, map };
    }

    async function carregarPlanoExercicios() {
        const resp = await fetch(`/api/plano-exercicios/${planoId}`);
        const itens = await resp.json();

        if (!Array.isArray(itens) || itens.length === 0) {
            conteudo.innerHTML = `<div class="list-empty">Ainda n√£o adicionaste exerc√≠cios ao plano.</div>`;
            return;
        }

        const { dias, map } = agruparPorDia(itens);
        conteudo.innerHTML = "";

        dias.forEach(dia => {
            const lista = map[dia];
            if (!lista || lista.length === 0) return;

            const card = document.createElement("div");
            card.className = "day-card";

            const h = document.createElement("h3");
            h.textContent = dia;
            card.appendChild(h);

            lista.forEach(item => {
                const row = document.createElement("div");
                row.className = "row";

                const left = document.createElement("div");
                left.className = "item-left";

                const title = document.createElement("div");
                title.className = "row-title";
                title.textContent = `${item.ordem}. ${item.exercicio_nome} (${item.grupo_nome})`;

                const meta = document.createElement("div");
                meta.className = "row-meta";
                meta.textContent = 
                    `${item.series} s√©ries x ${item.reps} reps` + 
                    (item.carga_sugerida_kg ? ` ‚Ä¢ ${item.carga_sugerida_kg} kg` : "") + 
                    (item.descanso_segundos ? ` ‚Ä¢ ${item.descanso_segundos}s descanso` : "");

                left.appendChild(title);
                left.appendChild(meta);

                if (item.video_caminho) {
                    const vw = document.createElement("div");
                    vw.className = "exercise-video-wrapper";
                    const v = document.createElement("video");
                    v.className = "exercise-video";
                    v.controls = true;
                    v.preload = "metadata";
                    v.src = item.video_caminho;
                    vw.appendChild(v);
                    left.appendChild(vw);
                }

                const actions = document.createElement("div");
                actions.className = "item-actions";

                const btnRemover = document.createElement("button");
                btnRemover.className = "danger-button";
                btnRemover.textContent = "Remover";
                btnRemover.onclick = async () => {
                    if (!confirm(`Remover "${item.exercicio_nome}"?`)) return;
                    const r = await fetch(`/api/plano-exercicios/${item.id}`, { method: "DELETE" });
                    if (r.ok) {
                        setMensagem("Exerc√≠cio removido", "sucesso");
                        carregarPlanoExercicios();
                    }
                };

                actions.appendChild(btnRemover);
                row.appendChild(left);
                row.appendChild(actions);
                card.appendChild(row);
            });

            conteudo.appendChild(card);
        });
    }

    formAdd.addEventListener("submit", async (e) => {
        e.preventDefault();
        setMensagem("", "");

        const dados = {
            plano_id: planoId,
            exercicio_id: selectEx.value,
            dia_semana: document.getElementById("diaSemana").value,
            ordem: document.getElementById("ordem").value,
            series: document.getElementById("series").value,
            reps: document.getElementById("reps").value,
            descanso_segundos: document.getElementById("descanso").value,
            carga_sugerida_kg: document.getElementById("carga").value
        };

        const resp = await fetch("/api/plano-exercicios", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados)
        });

        if (resp.ok) {
            setMensagem("Exerc√≠cio adicionado!", "sucesso");
            formAdd.reset();
            document.getElementById("ordem").value = 1;
            carregarPlanoExercicios();
        } else {
            const data = await resp.json();
            setMensagem(data.mensagem || "Erro ao adicionar.", "erro");
        }
    });

    document.getElementById('logoutButton').onclick = () => {
        localStorage.removeItem("user");
        window.location.href = "/login.html";
    };

    (async function init(){
        await carregarPlano();
        await carregarExerciciosSelect();
        await carregarPlanoExercicios();
    })();
</script>
</body>
</html>