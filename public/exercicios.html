<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exercícios</title>
  <link rel="stylesheet" href="css/exercicios.css" />
</head>
<body>
  <div class="page">
    <div class="header">
      <div class="title-block">
        <h1>Exercícios</h1>
        <p>Pesquisa exercícios por grupo muscular e por nome.</p>
      </div>

      <div class="nav">
        <a id="linkAdicionar" href="/adicionarExercicios.html">Adicionar</a>
        <a href="/dashboard.html">&larr; Dashboard</a>
      </div>
    </div>

    <div class="userbar">
      <span id="infoUser"></span>
    </div>

    <div class="filters">
      <div class="filters-grid">
        <div class="field">
          <label for="filtroGrupo">Grupo muscular</label>
          <select id="filtroGrupo">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="field">
          <label for="filtroNome">Nome do exercício</label>
          <input id="filtroNome" type="text" placeholder="Ex.: supino, agachamento..." />
        </div>

        <div class="actions">
          <button id="btnPesquisar" class="btn-primary" type="button">Pesquisar</button>
          <button id="btnLimpar" class="btn-secondary" type="button">Limpar</button>
        </div>
      </div>

      <p id="mensagem" class="msg"></p>
    </div>

    <div class="results-head">
      <h2>Resultados</h2>
      <div id="contador" class="results-count"></div>
    </div>

    <ul id="listaExercicios" class="grid">
      <li class="empty">A carregar...</li>
    </ul>
  </div>

<script>
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) window.location.href = "/login.html";

  const roleTratado = user.role === "admin" ? "Admin" : "Atleta";
  document.getElementById("infoUser").textContent =
    `Autenticado como: ${user.nome} — ${roleTratado}`;

  const linkAdicionar = document.getElementById("linkAdicionar");
  if (user.role !== "admin") linkAdicionar.style.display = "none";

  const filtroGrupo = document.getElementById("filtroGrupo");
  const filtroNome = document.getElementById("filtroNome");
  const btnPesquisar = document.getElementById("btnPesquisar");
  const btnLimpar = document.getElementById("btnLimpar");
  const listaEl = document.getElementById("listaExercicios");
  const msgEl = document.getElementById("mensagem");
  const contadorEl = document.getElementById("contador");

  function setMsg(texto, tipo) {
    msgEl.textContent = texto || "";
    msgEl.className = "msg";
    if (tipo === "erro") msgEl.classList.add("error");
    if (tipo === "sucesso") msgEl.classList.add("success");
  }

  async function carregarGrupos() {
    const resp = await fetch("/api/grupos-musculares");
    const grupos = await resp.json();

    filtroGrupo.innerHTML = `<option value="">Todos</option>`;
    (grupos || []).forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.nome;
      filtroGrupo.appendChild(opt);
    });
  }

  function renderLista(exercicios) {
    listaEl.innerHTML = "";

    if (!Array.isArray(exercicios) || exercicios.length === 0) {
      contadorEl.textContent = "0 resultados";
      listaEl.innerHTML = `<li class="empty">Sem resultados.</li>`;
      return;
    }

    contadorEl.textContent = `${exercicios.length} resultado(s)`;

    exercicios.forEach(e => {
      const li = document.createElement("li");
      li.className = "card";

      const top = document.createElement("div");
      top.className = "card-top";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = e.nome;

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = e.grupo_nome;

      top.appendChild(title);
      top.appendChild(badge);

      li.appendChild(top);

      if (e.descricao) {
        const desc = document.createElement("p");
        desc.className = "card-desc";
        desc.textContent = e.descricao;
        li.appendChild(desc);
      }

      if (e.video_caminho) {
        const v = document.createElement("video");
        v.className = "video";
        v.controls = true;
        v.preload = "metadata";
        v.src = e.video_caminho;
        li.appendChild(v);
      }

      listaEl.appendChild(li);
    });
  }

  async function pesquisar() {
    setMsg("", "");
    listaEl.innerHTML = `<li class="empty">A pesquisar...</li>`;
    contadorEl.textContent = "";

    const params = new URLSearchParams();
    if (filtroGrupo.value) params.set("grupoId", filtroGrupo.value);
    if (filtroNome.value.trim()) params.set("nome", filtroNome.value.trim());

    const resp = await fetch(`/api/exercicios?${params.toString()}`);
    const exercicios = await resp.json();
    renderLista(exercicios);
  }

  btnPesquisar.addEventListener("click", pesquisar);

  btnLimpar.addEventListener("click", () => {
    filtroGrupo.value = "";
    filtroNome.value = "";
    pesquisar();
  });

  // Enter no input faz pesquisar
  filtroNome.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      pesquisar();
    }
  });

  // opcional: pesquisar automático (fica muito “página de pesquisa”)
  let timer = null;
  filtroNome.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(pesquisar, 350);
  });
  filtroGrupo.addEventListener("change", pesquisar);

  (async function init() {
    await carregarGrupos();
    await pesquisar();
  })();
</script>
</body>
</html>
