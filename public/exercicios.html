<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exerc√≠cios - FitPlan PRO</title>
    <link rel="stylesheet" href="css/exercicios.css">
</head>
<body>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2>üèãÔ∏è FitPlan PRO</h2>
            <nav id="navMenu">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="planos.html" class="nav-link">Planos</a>
                <a href="historico.html" class="nav-link">Hist√≥rico</a>
                <a href="exercicios.html" class="nav-link active">Exerc√≠cios</a>
            </nav>
            <div class="logout-section">
                <a href="perfil.html" class="nav-link" style="margin-bottom: 10px;">Perfil</a>
                <button class="btn-logout" id="logoutButton">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="welcome-header">
                <h1>Galeria de Exerc√≠cios</h1>
                <p>Explora a biblioteca de movimentos ou adiciona novos.</p>
                <div style="margin-top: 1rem;">
                    <a id="linkAdicionar" href="adicionarExercicios.html" class="primary-button" style="display: none; width: auto; font-size: 0.9rem; padding: 0.6rem 1.2rem;">
                        + Adicionar Novo
                    </a>
                </div>
            </header>

            <div class="form-box">
                <div class="filters-grid">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filtroGrupo">Grupo Muscular</label>
                        <select id="filtroGrupo">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filtroNome">Pesquisar por nome</label>
                        <input id="filtroNome" type="text" placeholder="Ex: Supino, Agachamento..." />
                    </div>

                    <div class="actions">
                        <button id="btnPesquisar" class="secondary-button" type="button">Filtrar</button>
                    </div>
                </div>
                <p id="contador" style="margin-top: 10px; color: #9ca3af; font-size: 0.9rem; text-align: right;"></p>
            </div>

            <div class="list-section">
                <ul id="listaExercicios" class="list">
                    <li class="list-empty">A carregar biblioteca...</li>
                </ul>
            </div>
        </main>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) window.location.href = "/login.html";

        // ==================================================
        // L√ìGICA DE ADMIN (SIDEBAR + BOT√ÉO ADICIONAR)
        // ==================================================
        const linkAdicionar = document.getElementById("linkAdicionar");
        
        if (user.role === "admin") {
            // Mostrar bot√£o de adicionar
            linkAdicionar.style.display = "inline-block";

            // Injetar menu na sidebar
            const navMenu = document.getElementById("navMenu");
            const adminLinks = `
                <div class="admin-menu">
                    <p>Administra√ß√£o</p>
                    <a href="grupos.html" class="nav-link">Gerir Grupos</a>
                    <a href="adicionarExercicios.html" class="nav-link">Gerir Exerc√≠cios</a>
                </div>
            `;
            navMenu.insertAdjacentHTML('beforeend', adminLinks);
        }
        // ==================================================

        const filtroGrupo = document.getElementById("filtroGrupo");
        const filtroNome = document.getElementById("filtroNome");
        const btnPesquisar = document.getElementById("btnPesquisar");
        const listaEl = document.getElementById("listaExercicios");
        const contadorEl = document.getElementById("contador");

        async function carregarGrupos() {
            try {
                const resp = await fetch("/api/grupos-musculares");
                const grupos = await resp.json();
                filtroGrupo.innerHTML = `<option value="">Todos os Grupos</option>`;
                grupos.forEach(g => {
                    const opt = document.createElement("option");
                    opt.value = g.id;
                    opt.textContent = g.nome;
                    filtroGrupo.appendChild(opt);
                });
            } catch (e) {
                console.error("Erro ao carregar grupos", e);
            }
        }

        function renderLista(exercicios) {
            listaEl.innerHTML = "";
            
            if (!Array.isArray(exercicios) || exercicios.length === 0) {
                contadorEl.textContent = "0 exerc√≠cios encontrados";
                listaEl.innerHTML = `<li class="list-empty">Nenhum exerc√≠cio encontrado com estes filtros.</li>`;
                return;
            }

            contadorEl.textContent = `${exercicios.length} exerc√≠cio(s) encontrado(s)`;

            exercicios.forEach(e => {
                const li = document.createElement("li");
                li.className = "list-item"; 
                
                li.innerHTML = `
                    <div class="item-left" style="width: 100%;">
                        <span class="badge-muscular">${e.grupo_nome}</span>
                        <h3>${e.nome}</h3>
                        ${e.descricao ? `<p class="muted" style="margin-bottom: 1rem;">${e.descricao}</p>` : ''}
                        
                        ${e.video_caminho ? `
                            <div class="video-container">
                                <video class="exercise-video" controls preload="metadata">
                                    <source src="${e.video_caminho}" type="video/mp4">
                                    O teu browser n√£o suporta v√≠deo.
                                </video>
                            </div>
                        ` : '<div class="muted" style="font-style:italic; margin-top:1rem;">Sem v√≠deo dispon√≠vel.</div>'}
                    </div>
                `;
                listaEl.appendChild(li);
            });
        }

        async function pesquisar() {
            listaEl.innerHTML = `<li class="list-empty">A pesquisar...</li>`;
            
            const params = new URLSearchParams();
            if (filtroGrupo.value) params.set("grupoId", filtroGrupo.value);
            if (filtroNome.value.trim()) params.set("nome", filtroNome.value.trim());

            try {
                const resp = await fetch(`/api/exercicios?${params.toString()}`);
                const exercicios = await resp.json();
                renderLista(exercicios);
            } catch (err) {
                listaEl.innerHTML = `<li class="list-empty">Erro ao carregar exerc√≠cios.</li>`;
            }
        }

        btnPesquisar.onclick = pesquisar;
        
        let timer = null;
        filtroNome.oninput = () => {
            clearTimeout(timer);
            timer = setTimeout(pesquisar, 400);
        };
        filtroGrupo.onchange = pesquisar;

        document.getElementById('logoutButton').onclick = () => {
            localStorage.removeItem("user");
            window.location.href = "/login.html";
        };

        (async function init() {
            await carregarGrupos();
            await pesquisar();
        })();
    </script>
</body>
</html>